name: Scheduled Build

# Run a complete build-and-test cycle every Monday at 08:00 UTC so that
# broken dependencies (new indirect dep versions, expired API tokens, etc.)
# are caught before a developer tries to land a PR on a broken base.
#
# This workflow is intentionally separate from the per-PR CI workflow so that
# scheduled failures do not block PR merges and vice-versa.
on:
  schedule:
    - cron: '0 8 * * 1'   # Every Monday 08:00 UTC
  workflow_dispatch: {}    # Allow manual triggering from the Actions UI

jobs:
  full-build:
    name: Full Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # ── Backend ──────────────────────────────────────────────────────────

      - name: Go — mod tidy check
        working-directory: backend
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || \
            (echo "go.mod/go.sum drift detected — run 'go mod tidy'" && exit 1)

      - name: Go — build
        working-directory: backend
        run: go build ./...

      - name: Go — vet
        working-directory: backend
        run: go vet ./...

      - name: Go — test (race detector + coverage)
        working-directory: backend
        run: go test ./... -race -coverprofile=coverage.out -covermode=atomic

      - name: Go — coverage summary
        working-directory: backend
        run: go tool cover -func=coverage.out | tail -1

      # ── Docker ───────────────────────────────────────────────────────────

      - name: Docker — build backend image
        run: docker build -t terraform-registry-backend:scheduled backend/

      # ── Artifacts ────────────────────────────────────────────────────────

      - name: Upload Go coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scheduled-coverage-${{ github.run_id }}
          path: backend/coverage.out
          retention-days: 14

  # Notify on failure via a GitHub issue comment (optional but visible).
  notify-on-failure:
    name: Create issue on failure
    runs-on: ubuntu-latest
    needs: full-build
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Scheduled build failed — ${new Date().toISOString().slice(0,10)}`;
            const body = [
              '## Scheduled Build Failure',
              '',
              `**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              '',
              'The weekly scheduled build failed.  Please investigate and fix before the next release.',
              '',
              'Common causes:',
              '- A transitive Go dependency published a breaking change',
              '- The Docker base image changed in a breaking way',
              '- A gosec or audit finding was introduced',
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug', 'ci'],
            });
